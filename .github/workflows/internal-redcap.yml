name: Internal REDCap Check

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  redcap-internal:
    runs-on: [self-hosted, linux, internal]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check internal REDCap
        id: check
        shell: bash
        run: |
          set -e
          URL="http://redcap-crsm.comtl.rtss.qc.ca/"
          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          CODE="$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo 000)"

          mkdir -p history/internal
          echo "$TS $CODE $URL" >> history/internal/redcap.log

          if [ "$CODE" -ge 200 ] && [ "$CODE" -lt 400 ]; then
            echo "REDCap OK ($CODE)"
          else
            echo "REDCap DOWN ($CODE)"
            exit 1
          fi

      - name: Commit result
        run: |
          git config user.name "Upptime Internal Runner"
          git config user.email "upptime-internal@users.noreply.github.com"
          git add history/internal/redcap.log
          git diff --staged --quiet || git commit -m "internal: REDCap check"
          git push
